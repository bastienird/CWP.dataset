# WARNING - Generated by {fusen} from dev/flat_first.Rmd: do not edit by hand # nolint: line_length_linter.

#' Save Plots with Subfigures in a Knitr Environment
#'
#' @description This function saves plots and creates subfigures for rendering in RMarkdown.
#' @param plot The plot object to save.
#' @param title A character string for the plot title.
#' @param folder The folder where the plot will be saved.
#' @param fig.pathinside The path for saving the figure.
#' @return None
#' @export
knitting_plots_subfigures <- function(plot, title, folder = "Unknown_folder", fig.pathinside = fig.path) {
  # Check if the function is being run in a knitr environment
  in_knitr <- !is.null(knitr::opts_knit$get("out.format"))

  # Save the ggplot object in the current environment with a unique name
  if(is_ggplot(plot)) {
    save_image(title = title, plott = plot, folder = folder, fig.pathinside = fig.pathinside)
    if(in_knitr) {
      # This will run if inside a knitr/RMarkdown environment

      # Adjust title for use in fig.cap
      assign("title_adj", gsub("_", "-", title), envir = environment())
      assign("plot_obj", plot, envir = environment())

      # Create the R chunk as a string referencing the ggplot object by its name
      knitr::knit_child(text = c(
        '```{r evolvaluedimdiff, fig.cap=`title_adj`, fig.align = "center", out.width = "100%", results= "asis"}',
        '',
        '',
        'plot(plot_obj)',
        '',
        '```'
      ), envir = environment(), quiet = TRUE)
    } else {
      # This will run if outside a knitr/RMarkdown environment (e.g., in a plain R script)
      print(plot)
    }
  } else if (inherits(plot, "tmap")) {
    if(in_knitr) {
      # This will run if inside a knitr/RMarkdown environment

      # Adjust title for use in fig.cap
      assign("title_adj", gsub("_", "-", title), envir = environment())
      assign("plot_obj", plot, envir = environment())

      # Create the R chunk as a string referencing the ggplot object by its name
      knitr::knit_child(text = c(
        '```{r evolvaluedimdiff, fig.cap=`title_adj`, fig.align = "center", out.width = "100%", results= "asis"}',
        '',
        '',
        'plot_obj',
        '',
        '```'
      ), envir = environment(), quiet = TRUE)
    } else {
      # This will run if outside a knitr/RMarkdown environment (e.g., in a plain R script)
      plot
    }
  } else {
    stop("Not a ggplot or tmap object")
  }
}

