# WARNING - Generated by {fusen} from dev/flat_first.Rmd: do not edit by hand # nolint: line_length_linter.

#' Documentation to do 
#' @name generate_plot
#' @rdname generate_plot
#' @description Documentation to do 
#' @param data A data frame representing the first dataset cleaned
#' @param title Title for the plot
#' @param dimensioninside The dimension for the plot
#' @param topninside An integer for the number of top categories to display.
#' @export
generate_plot <- function(data, title, dimensioninside, topninside) {

    data_summary <- data %>%
      dplyr::group_by(dplyr::across(c(dimensioninside,   "measurement_unit", dataset))) %>% dplyr::summarise(measurement_value = sum(measurement_value, na.rm = TRUE)) %>% dplyr::group_by(measurement_unit, dataset) %>%
      dplyr::arrange(desc(measurement_value)) %>% dplyr::mutate(id = row_number()) %>%
      dplyr::mutate(class = as.factor(ifelse(id < topn, !!rlang::sym(dimensioninside), "Others"))) %>%       dplyr::group_by(class, measurement_unit, dataset) %>%
      dplyr::summarise(measurement_value = sum(measurement_value, na.rm = TRUE)) %>%
      group_by(measurement_unit, dataset) %>%
      dplyr::arrange(desc(ifelse(class == "Others", -Inf, measurement_value))) # Order data

    # Reorder class as a factor
    # data_summary$class <- factor(data_summary$class, levels = data_summary$class)

    # Create the bar plot
    plot <- ggplot(data = data_summary, aes(x = class, y = measurement_value, fill = class, color = class)) +
      geom_col() +
      labs(x = dimension, y = "Total Measurement") +
      scale_y_continuous(labels = function(x) prettyNum(x, big.mark = ",")) +
      theme(legend.position = "bottom",
            legend.title = element_blank(),
            legend.text = element_text(size = 7),
            legend.key.size = unit(.4, "cm"),
            axis.text.x = element_blank()) +
      ggtitle(title)+
      facet_grid(c("measurement_unit", "dataset"))


    if (!is.null(fill_colors) && !is.null(outline_colors)) {
      plot <- plot +
        scale_fill_manual(values = fill_colors) +
        scale_color_manual(values = outline_colors)
    }

    return(plot)
  }

