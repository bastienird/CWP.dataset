# WARNING - Generated by {fusen} from dev/flat_first.Rmd: do not edit by hand

#' Compute Summary of Differences
#'
#' This function computes the summary of differences in measurement values
#' between two datasets by grouping them by measurement unit and calculating
#' the sum of values. It also computes the percentage difference.
#'
#' @param init A data.table containing the initial measurement data.
#' @param final A data.table containing the final measurement data.
#' @param titre_1 A character string for the title of the first dataset (default: "Dataset 1").
#' @param titre_2 A character string for the title of the second dataset (default: "Dataset 2").
#'
#' @return A data.table summarizing the differences between the two datasets,
#'         including total measurements and percentage differences.
#' @export
compute_summary_of_differences <- function(init, final, titre_1 = "Dataset 1", titre_2 = "Dataset 2") {

  # Ensure input data are data.tables
  init <- as.data.table(init)
  final <- as.data.table(final)

  # Group and summarize initial dataset
  init_group <- init[, .(titre_test1 = sum(measurement_value, na.rm = TRUE)), by = measurement_unit]

  # Group and summarize final dataset
  final_group <- final[, .(titre_test2 = sum(measurement_value, na.rm = TRUE)), by = measurement_unit]

  # Compute summary of differences
  summary <- merge(init_group, final_group, by = "measurement_unit", all = TRUE)

  # Replace NA with 0 in numeric columns and calculate differences
  summary[is.na(titre_test1), titre_test1 := 0]
  summary[is.na(titre_test2), titre_test2 := 0]

  summary[, Difference := -titre_test1 + titre_test2]
  summary[, `Difference (in %)` := 100 * (Difference / titre_test1)]

  # Rename columns for clarity
  setnames(summary, "titre_test1", titre_1)
  setnames(summary, "titre_test2", titre_2)

  # Arrange the summary by measurement_unit
  setorder(summary, measurement_unit)

  return(summary)
}
