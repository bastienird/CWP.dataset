# WARNING - Generated by {fusen} from dev/flat_first.Rmd: do not edit by hand

#' Group and Summarize Data
#'
#' This function takes two data.tables and groups them by specified columns,
#' summing the measurement values for each group, and then compares the results
#' from both data.tables. It computes the loss or gain in measurement values
#' and provides additional metrics related to the comparison.
#'
#' @param these_col A character vector of column names to group by.
#' @param init A data.table containing the initial measurement data.
#' @param final A data.table containing the final measurement data.
#'
#' @return A data.table containing the results of the comparison between the
#'         two input data.tables, including summed values, losses or gains,
#'         and percentage differences.
#' @export
fonction_groupement <- function(these_col, init, final) {

  # Ensure input data are data.tables
  init <- as.data.table(init)
  final <- as.data.table(final)

  # Compute sum of values for each combination of the columns in "these_col"
  # and "measurement_unit" in the "init" data.table
  groupement_1 <- init[, .(value_sum_1 = round(sum(measurement_value, na.rm = TRUE), digits = 3),
                           number_lines1 = .N),
                       by = c(these_col, "measurement_unit")]

  groupement_1[, measurement_unit := as.character(measurement_unit)]
  groupement_1[is.na(value_sum_1), value_sum_1 := 0]

  # Compute sum of values for each combination of the columns in "these_col"
  # and "measurement_unit" in the "final" data.table
  groupement_2 <- final[, .(value_sum_2 = round(sum(measurement_value, na.rm = TRUE), digits = 3),
                            number_lines2 = .N),
                        by = c(these_col, "measurement_unit")]

  groupement_2[, measurement_unit := as.character(measurement_unit)]
  groupement_2[is.na(value_sum_2), value_sum_2 := 0]

  # Join the two data.tables based on the columns in "these_col" and "measurement_unit"
  fulljoin <- merge(groupement_1, groupement_2,
                    by = c(these_col, "measurement_unit"),
                    all = TRUE,
                    suffixes = c("_1", "_2"))

  fulljoin[is.na(value_sum_1), value_sum_1 := 0]
  fulljoin[is.na(value_sum_2), value_sum_2 := 0]

  # Calculate losses and gains
  fulljoin[, loss := value_sum_1 - value_sum_2]
  fulljoin[, `Loss / Gain` := fifelse(abs(loss) <= 1, "Egal",
                                      fifelse(loss > 1, "Loss", "Gain"))]
  fulljoin[, Loss_pourcent := -100 * (loss / value_sum_1)]

  # Handle NA values in Loss_pourcent
  fulljoin[is.na(Loss_pourcent) | Loss_pourcent == -Inf, Loss_pourcent := 100]

  # Add additional columns
  fulljoin[, Dimension := names(groupement_1)[1]]
  setnames(fulljoin, "measurement_unit", "Precision")
  fulljoin[, Precision := as.character(Precision)]

  # Calculate differences
  fulljoin[, loss_nb_ligne := - (number_lines1 - number_lines2)]
  fulljoin[, `Difference in value` := - (value_sum_1 - value_sum_2)]
  setnames(fulljoin, "Loss_pourcent", "Difference (in %)")
  setnames(fulljoin, "loss_nb_ligne", "Difference in number of lines")

  # Replace NA with 0 for numeric columns
  fulljoin[, lapply(.SD, function(x) replace(x, is.na(x), 0)), .SDcols = where(is.numeric)]

  return(fulljoin)
}
