# WARNING - Generated by {fusen} from dev/flat_first.Rmd: do not edit by hand # nolint: line_length_linter.

#' Perform Multiple Comparisons Between Datasets
#'
#' This function performs various summarizing steps on datasets related to species and gear types. 
#' It retrieves data from a database, processes it, and generates comparison reports.
#'
#' @param counting Integer. The step number in the comparison process.
#' @param parameter_short Character. A short version of the parameter name.
#' @param sub_list_dir Character vector. A list of directories containing data to be compared.
#' @param parameters_child_global List. A list of global child parameters for filtering and resolution settings.
#' @param fig.path Character. Path to save comparison figures.
#' @param coverage Logical. Whether to include coverage analysis in the comparison (default: `FALSE`).
#' @param shapefile.fix Object. A fixed shapefile for spatial adjustments.
#' @param continent Object. A continent shape for plotting worldmaps.
#'
#' @return A list containing comparison results, metadata, and visualization elements. If the datasets are identical, it returns `NA`.
#'
#' @details The function compares datasets between two consecutive steps, applying data filtering and analysis. 
#' It generates structured output reports stored in `fig.path`.
#'
#' @examples
#' \dontrun{
#' result <- function_multiple_comparison(
#'   counting = 1,
#'   parameter_short = "gear_analysis",
#'   sub_list_dir = c("step1", "step2"),
#'   parameters_child_global = list(parameter_resolution_filter = 1, parameter_filtering = "strict"),
#'   fig.path = "output/",
#'   coverage = FALSE,
#'   shapefile.fix = NULL,
#'   continent = "Europe"
#' )
#' }
#'
#' @import dplyr
#' @import sf
#' @import futile.logger
#' @import qs
#' @export
function_multiple_comparison <- function(counting, parameter_short, sub_list_dir, 
                                         parameters_child_global, fig.path, coverage = FALSE, 
                                         shapefile.fix, continent) {
  gc()
  
  parameter_init <- file.path(sub_list_dir[counting], "data.qs")
  parameter_final <- file.path(sub_list_dir[counting + 1], "data.qs")
  parameter_titre_dataset_1 <- basename(sub_list_dir[counting])
  parameter_titre_dataset_2 <- basename(sub_list_dir[counting + 1])

  new_path <- file.path(fig.path, "Comparison", 
                        paste0(parameter_titre_dataset_1, "_", parameter_titre_dataset_2))
  dir.create(new_path, recursive = TRUE, showWarnings = FALSE)

  flog.info("Starting comparison between: %s and %s | Coverage: %s", 
            parameter_titre_dataset_1, parameter_titre_dataset_2, coverage)

  initfiltered <- filtering_function(qs::qread(parameter_init))
  finalfiltered <- filtering_function(qs::qread(parameter_final))

  if (!identical(initfiltered, finalfiltered)) {
    rm(initfiltered, finalfiltered)
    flog.info("Datasets are different: %s vs %s", parameter_titre_dataset_1, parameter_titre_dataset_2)

    child_env_result <- comprehensive_cwp_dataframe_analysis(
      parameter_init = parameter_init,
      parameter_final = parameter_final,
      fig.path = new_path,
      parameter_fact = "catch",
      plotting_type = "view",
      parameter_colnames_to_keep = c("source_authority", "species", "gear_type", "fishing_fleet",
                                     "fishing_mode", "geographic_identifier",
                                     "measurement_unit", "measurement_value", "GRIDTYPE",
                                     "species_group", "Gear"),
      shapefile_fix = shapefile.fix,
      continent = continent,
      coverage = coverage,
      parameter_resolution_filter = parameters_child_global$parameter_resolution_filter,
      parameter_filtering = parameters_child_global$parameter_filtering,
      parameter_titre_dataset_1 = parameter_titre_dataset_1,
      parameter_titre_dataset_2 = parameter_titre_dataset_2,
      unique_analyse = FALSE
    )

    flog.info("Analysis completed for: %s vs %s", parameter_titre_dataset_1, parameter_titre_dataset_2)

    child_env_result$step_title_t_f <- TRUE
    child_env_result$step_title <- paste0(" Treatment : ", basename(sub_list_dir[counting + 1]))
    child_env_result$step <- counting
    child_env_result$parameter_titre_dataset_1 <- parameter_titre_dataset_1
    child_env_result$parameter_titre_dataset_2 <- parameter_titre_dataset_2
    child_env_result$child_header <- "##"

    gc()
    flog.info("New result saved to: %s", new_path)
    return(child_env_result)
  } else {
    rm(initfiltered, finalfiltered)
    flog.info("Datasets are identical, skipping comparison for: %s vs %s", 
              parameter_titre_dataset_1, parameter_titre_dataset_2)
    return(NA)
  }
}
