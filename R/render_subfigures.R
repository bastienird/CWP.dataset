# WARNING - Generated by {fusen} from dev/flat_first.Rmd: do not edit by hand # nolint: line_length_linter.

#' Render Subfigures from a List of Plots
#'
#' @description This function creates a grid of subfigures from a list of plots and titles.
#' @param plots_list A list of plot objects.
#' @param titles_list A list of character strings for plot titles.
#' @param general_title A character string for the general title of the plots.
#' @return None
#' @export
render_subfigures <- function(plots_list, titles_list, general_title) {
  # Check if the function is being run in a knitr environment
  in_knitr <- !is.null(knitr::opts_knit$get("out.format"))
  
  # Check if the lists are of the same length
  if (length(plots_list) != length(titles_list)) {
    stop("The lengths of plots_list and titles_list are not the same.")
  }
  
  # Check if all plots are ggplots
  if (!all(sapply(plots_list, inherits, "gg"))) {
    stop("Not all items in plots_list are ggplot objects.")
  }
  
  # Determine the output format
  output_format <- knitr::opts_knit$get("out.format")
  
  if (in_knitr) {
    if (output_format == "html") {
      # Use gridExtra for HTML output
      library(gridExtra)
      library(grid)
      
      # Combine plots with captions using gridExtra::arrangeGrob
      plot_grobs <- lapply(seq_along(plots_list), function(i) {
        arrangeGrob(
          plots_list[[i]], 
          bottom = grid::textGrob(
            titles_list[[i]], 
            gp = grid::gpar(fontsize = 10), 
            vjust = -0.5  # Adjust vjust to bring caption closer to plot
          )
        )
      })

      # Arrange the plots side by side using grid.arrange
      grid.arrange(
        grobs = plot_grobs, 
        ncol = 2,  # Arrange in two columns
        widths = c(1, 1),  # Ensure equal width for each plot
        top = textGrob(general_title, gp = gpar(fontsize = 14, fontface = "bold"))
      )
      
    } else {
      # For non-HTML outputs (e.g., PDF), use subfigures as before
      subcaps <- lapply(titles_list, function(title) paste0("(", title, ")"))
      
      chunk_header <- sprintf(
        '```{r subfigures, fig.cap="%s", fig.subcap=c(%s), fig.ncol=2, out.width="50%%", fig.align="center"}',
        general_title,
        paste0('"', subcaps, '"', collapse=", ")
      )
      
      for (i in seq_along(plots_list)) {
        assign(paste0("plot_", i), plots_list[[i]], envir = environment())
      }
      
      plot_commands <- lapply(seq_along(plots_list), function(i) {
        paste0("print(plot_", i, ")")
      })
      
      chunk_text <- paste(chunk_header, paste(plot_commands, collapse = '\n'), '```', sep = '\n')
      
      result <- knitr::knit_child(text = chunk_text, envir = environment(), quiet = TRUE)
      cat(result)
    }
  } else {
    # If not in a knitr environment, just print the plots
    for (plot in plots_list) {
      print(plot)
    }
  }
}

